create database pepper;
select * from customers;
select * from orders;
select * from employee;
#1
select * from employee_cleaned;

select 
max(salary) as max_salary
from employee_cleaned
where salary<(
select 
max(salary)
from employee_cleaned);

#2
select 
name,
count(*) 
from employee_cleaned
group by name 
having count(*) >1;

#3
select 
department_id,
count(*) as num_emp
from employee_cleaned
group by department_id
having count(*) >5;

#4
select 
* from employee_cleaned
where hire_date>=current_date-
interval 6 month;

#5
select * from departments;
select 
d.department_name 
from departments d
left join employee_cleaned e on d.department_id=e.department_id
where e.id is null;

#6
select 
name,
department_id,
id,
sum(salary) over(partition by department_id order by id) as rnk_dept
from employee_cleaned;

select * from user_logins;

WITH login_dates AS (
 SELECT user_id, login_date,
 login_date - INTERVAL ROW_NUMBER()
OVER (PARTITION BY user_id ORDER BY
login_date) DAY AS grp
 FROM user_logins
)
SELECT user_id, COUNT(*) AS streak_length,
MIN(login_date) AS start_date, MAX(login_date) AS
end_date
FROM login_dates
GROUP BY user_id, grp;
#7
with login_dates as
(
select 
user_id,login_date,
login_date - interval row_number() over(partition by user_id order by login_date) day as rnk_date
from user_logins
) 
select
user_id,
count(*) as streak_length,
min(login_date) as min_date,
max(login_date) as end_date
from login_dates
group by user_id
order by streak_length,min_date,end_date;

#8
with recursive reporting_chain as 
(
select 
id,
name,
manager_id,
1 as level
from employee
where manager_id is null 
union all 
select 
e.id,
e.manager_id,
e.name,
rc.level+1
from  employee e join reporting_chain rc on e.manager_id=rc.id
)
select * from reporting_chain order by level ,id;

WITH RECURSIVE reporting_chain AS (
 SELECT id, name, manager_id, 1 AS level
 FROM employee
 WHERE manager_id IS NULL
 UNION ALL
 SELECT e.id, e.name, e.manager_id, rc.level + 1
 FROM employee e
 JOIN reporting_chain rc ON e.manager_id = rc.id
)
SELECT * FROM reporting_chain ORDER BY level,
id;

select * from employee;

#9
select 
(id+1) as missing_values
from employee e1
where not exists
(
select 1 from employee e2 where e2.id=e1.id
)
order by missing_values;
#10
select
name,id,salary,
cume_dist() over (order by salary) 
from employee;
#11
SELECT *
FROM table1 t1
JOIN table2 t2 ON t1.id = t2.id
WHERE NOT (t1.col1 <=> t2.col1)
   OR NOT (t1.col2 <=> t2.col2)
   OR NOT (t1.col3 <=> t2.col3);
#12
select 
name,
salary ,
rank() over(order by salary desc) as salary_rank 
from employee;

#13
select * from customers;
select * from sales;
select 
c.customer_id,
c.name
from customers c join sales s on c.customer_id=s.customer_id
where s.sale_id is null;
#14
select
department_id,
count(case when gender='m' then 1 end ) as  male_count,
count(case when gender='f' then 1 end) as female_count
from employee 
group by department_id;
#15
select 
name,salary,
salary - lag(salary) over(order by id) as salary_diff
from employee;
#16
select * from employee;

select
name,
salary 
from employee
where salary > (select avg(salary) from employee) 
order by salary desc;

#17 
select 
department_id,
json_arrayagg(name) as employee_name 
from employee 
group by department_id;

#18 
select
e.name as employe_name,
e.salary,
m.name as manager_namev from employee e 
join employee m on e.manager_id=m.id
where e.salary=m.salary;
#19 
select
customer_id,
max(sale_date)as last_date,
min(sale_date) as first_date
from sales
group by customer_id;
#20 
with avg_Salary as 
(
select 
department_id,
avg(salary) as avg_salary 
from employee
group by department_id
)
select * from avg_salary 
where avg_salary=(select max(avg_salary) from avg_salary);

#21
select 
job_title ,
count(*) as total_jobs 
from employee
group by job_title;

#22
select 
* from employee_cleaned
where department_id is null;

#23
select * from project_assignments;

select
assignment_id ,
datediff(end_date,start_date) as day_diff
from project_assignments;

#24
select * from employee;

select 
name,
hire_date,
salary,
avg(salary) over(order by hire_date rows between 2 preceding and current row) as moving_salary 
from employee;

#25
select * from 
(select 
*,row_number() over(partition by customer_id order by sale_date desc) as rn from sales
) sub
where rn=1;

#26
with recursive employee_dept as 
(
select 
id,
name,
manager_id,
 1 as depth
 from employee
 where manager_id is null
 union all 
 select e.id ,
 e.name,
 e.manager_id,
 ed.depth+1
 from employee  e join employee_dept  ed on e.manager_id=e.id
 )
 select * from employee_dept;
 
 #27
 select * from employee;
 
 select 
 e1.id,
 e2.id,
 e1.department_id 
 from employee e1 
 join employee e2 
 on e1.department_id=e2.department_id and e1.id<e2.id;
 
 #28
 select 
 department_id,
 sum(case when job_title="manager" then 1 else 0 end) as mangers,
 sum(case when job_title="developer" then 1 else 0 end) AS DEVELOPER,
 sum(case when job_title="tester" then 1 else 0 end) as tester
 from employee
 group by department_id;
 
 select * from sales;
 
 #29
 select
 customer_id 
 from sales s
 group by customer_id 
 having count(distinct product_id)=
 (select count(distinct product_id) from sales);
 
 #30 
 select * from salary_history;
 select 
 e.name ,
 e.id
 from employee e
 join salary_history s on e.id=s.employee_id
 group by e.name,e.id
 having max(s.change_date)<current_date-interval 1 year;
 
 select * from sales;
 
 #31
 select 
 salesperson_id,
 sale_month,total_sales
 from 
 (
 select 
 salesperson_id,date_format(sale_date,'%Y-%m-%01') as sale_month,
 sum(amount) as total_sales
 from sales
 group by salesperson_id,sale_month
 ) as monthly_sales;
 
 #31
 select 
 product_id,
 sale_month,
 total_sales
 ,
 (total_sales - lag(total_sales) over (partition by product_id order by sale_month)) *100.0/
 lag(total_sales) over(partition by product_id order by sale_month) as pct_change 
 from 
 (
 select 
 product_id,date_format(sale_date,'%Y-%m-%01') as sale_month,
 sum(amount) as total_sales
 from sales
 group by product_id,sale_month
 ) monthly_sales;
 
 #32
 select 
 * from employee e
 where salary>
 (
 select 
 avg(salary) from employee) and salary<(
 select max(salary) from employee where department_id=e.department_id
 );
 
 #33
 select 
 * from 
 (select o.*,row_number() over(partition by customer_id order by order_date desc) as rn
 from orders o
 )
 sub
 where rn<=5;
 
 #35
 select
 e.*
 from employee e 
 join salary_history sh 
 on e.id=sh.employee_id and sh.change_date >=current_date - interval 2 year
 where sh.employee_id is null;
 
 #36
 select 
 department_id,
 avg(salary) as avg_salary 
 from employee 
 group by department_id
 order by avg_salary
 limit 1;
 
 #37
 select 
 * from employee
 where left(name,1)=right(name,2);
 
 #38
 with recursive mgr_path(id,manager_id,path)
 as(
 select id,manager_id,CAST(id AS CHAR(200)) AS path
 where manager_id is not null
 union all 
select 
e.id,
e.manager_id,
path||e.id from employee e 
join mgr_path mp on e.manager_id=mp.id
where not e.id=any(path)
)
select distinct id 
from mrg_path 
where id=any(path);

#39
select
customer_id,
sale_date,
amount,
sum(amount) over(partition by customer_id order by sale_date) as sum_sal
from sales ;

#40
select 
distinct department_id,salary,
PERCENTILE_CONT(0.9) within group(order by salary)  as pct_90_salary 
from employee
GROUP BY DEPARTMENT_ID;

#41
WITH prime as 
(
select generate_series(2,(select max(salary) from employee)) as num 
select num from 
(
select num ,unnest (array(
select generate_series(2,floor(sqrt(num)))
as divisor 
))as divisor
where num%divisor==0
)as composite 
)
select * from employee 
where salary in(select num from primes );

#41
SET SESSION cte_max_recursion_depth = 50000;

with recursive numbers as 
(
select 2 as num
union all 
select num+1 from numbers 
where num<least((select max(salary) from employee),50000)
),
prime as
(
select 
n1.num
from numbers n1
where n1.num>1
and not exists 
(
select 1
from numbers n2
where n2.num between 2 and floor(sqrt(n1.num))
and n1.num%n2.num=0
)
)
select * from 
employee 
where salary in (select num from prime);

#42
select * from departments;
select 
id
department_id 
from employee
group by id 
having count(distinct department_id)>1;

#43
select 
product_id,
sale_date,
amount,
amount - lag(amount) over (partition by product_id order by sale_date) as sale_diff
from sales;

#44
select * from employee e 
where not exists 
(
select 1 from employee sub where sub.manager_id=e.id);


#45
select 
date_format(order_date,'%Y-%m-%01') as order_month,
shipping_method,
avg(order_value) as avg_order_value 
from orders 
group by order_date,shipping_method 
order by order_date,shipping_method ;



select * from orders;


#46
SELECT join_year, COUNT(*) AS yearly_hires,
 SUM(COUNT(*)) OVER (ORDER BY join_year)
AS running_total_hires
FROM (
 SELECT EXTRACT(YEAR FROM hire_date) AS
join_year
 FROM employee
) sub
GROUP BY join_year
ORDER BY join_year;

select 
join_year,
count(*) as yearly_hires,
sum(count(*)) over(order by join_year)
as running_total_hires 
from (
select extract(YEAR FROM hire_date) as join_year
from employee 
) sub 
group by join_year
order by join_year;

#47
select * from orders;

select 
customer_id,
order_date
from 
(
select customer_id,
order_date,
row_number() over(partition by customer_id order by order_date desc ) as rn 
from orders 
) sub
where rn=2;

#48
select 
e.id,
e.name
from employee e 
left join sales s on e.id=s.sale_id
where s.sale_id is null;

#49
select
department_id,
avg(timestampdiff(YEAR,hire_Date,curdate())) as avg_tenture_year 
from employee
group by department_id;

#50 
select *
from 
(
select 
e.*,
ntile(10) over(partition by department_id order by salary desc) as decile
from employee e
) as sub
where decile=1;
select * from sales ;
#51
select 
customer_id,
sale_date,
count(*) as purchase_count
from sales
group by customer_id,sale_date
having count(*)>1;

#52
select 
count(e.id) as emp_count,
d.department_name,
e.department_id 
from employee e join departments d 
on e.department_id=d.department_id
group by e.department_id,d.department_name;

#53
select 
id,
name, 
count(*) from employee
group by id,name 
having count(*) >1;

#54
WITH RECURSIVE factorial(n, fact) AS (
 SELECT 1, 1
 UNION ALL
 SELECT n + 1, fact * (n + 1)
 FROM factorial
 WHERE n < 5
)
SELECT fact FROM factorial WHERE n = 5;
select * from sales;
#55
select 
product_id,
amount,
sum(amount) over(order by amount desc)*100.0/sum(amount)over() as cumulative_pct 
from sales;

#56
WITH RECURSIVE reporting AS (
 SELECT id, name, manager_id
 FROM employee
 WHERE manager_id = 101 -- replace 101 with manager's id
 UNION ALL
 SELECT e.id, e.name, e.manager_id
 FROM employee e
 INNER JOIN reporting r ON e.manager_id = r.id
)
SELECT * FROM reporting;

with recursive reporting as 
(
select id,name,manager_id 
from employee 
where manager_id=101 -- replace 101 with manager's id 
union all 
select e.id,e.name,e.manager_id
from employee e 
inner join reporting r on e.manager_id=r.id 
)
select * from reporting;

#57
select * from orders;
select 
avg(order_count) as avg_count,
stddev(order_count) as stdd_count
from 
(
select customer_id,count(*) as order_count
from orders 
group by customer_id
) as sub;

#58
WITH dates AS (
 SELECT customer_id, sale_date,
 LAG(sale_date) OVER (PARTITION BY
customer_id ORDER BY sale_date) AS prev_date
 FROM sales
)
SELECT customer_id, prev_date + INTERVAL 1 day as missing_date
FROM dates
WHERE sale_date > prev_date + INTERVAL 1
day;

with dates as 
(
select 
customer_id,sale_date,
lag(sale_date) over(partition by customer_id order by sale_date) as prev_Date 
from sales 
)
select customer_id,prev_date +interval 1 day as missing_date 
from dates 
where sale_date >prev_date + interval 1
day;

#59 
select 
name,department_id,salary,
rank() over(partition by department_id order by salary desc) as salary_rnk ,
percent_rank() over(partition by department_id order by salary desc) as salary_percent_rank
from employee;

#60
select * from products;

select 
p.product_id,p.product_name
from products p 
left join sales s on p.product_id=s.product_id
where s.sale_id is null;

#61
WITH flagged_sales AS (
 SELECT sale_date, amount,
 CASE WHEN amount > 1000 THEN 1 ELSE 0
END AS flag
 FROM sales
),
group_s AS (
 SELECT sale_date, amount, flag,
 sale_date - INTERVAL ROW_NUMBER()
OVER (ORDER BY sale_date) DAY AS grp
 FROM flagged_sales
 WHERE flag = 1
)
SELECT MIN(sale_date) AS start_date,
MAX(sale_date) AS end_date, COUNT(*) AS
consecutive_days
FROM group_s
GROUP BY grp
ORDER BY consecutive_days DESC;

with flagged_sales as
(
select sale_date,amount,
case when amount > 1000 then 1 else 0 
end as flag
from sales 
),
group_s as (
select sale_date,amount,flag,
sale_date - interval row_number()
over(order by sale_date) day as grp 
from flagged_sales
where flag=1
)
select min(sale_date) as start_date,
max(sale_date) as end_date ,count(*) as consecutive_days
from group_s
group by grp 
order by consecutive_days desc;

#62
select 
department_id,group_concat(name,",") as employee_name 
from employee 
group by department_id;

#63
select * from 
employee e 
where salary >(
select avg(salary) from employee where department_id=e.department_id
)and salary<(select avg(salary) from employee);

#64
select * from products;
select * from sales ;

select 
customer_id
from sales
where category_id=9
group by customer_id 
having count(distinct product_id)=(
select 
count(distinct product_id),category_id
from products 
where category_id=9
);


#65
select
distinct salary 
from employee 
order by salary desc 
limit 1;

#66
select * from salary_history;

select e.* from employee e 
left join salary_history sh on e.id=sh.employee_id
where sh.employee_id is null;

#67
select 
department_id,
count(*) as empl_count
from employee 
group by department_id
order by empl_count desc 
limit 1 ;

#68 
WITH RECURSIVE ancestors AS (
 SELECT id, name, manager_id
 FROM employees
 WHERE id = 123 -- given employee id
 UNION ALL
 SELECT e.id, e.name, e.manager_id
 FROM employees e
 JOIN ancestors a ON e.id = a.manager_id
)
SELECT * FROM ancestors WHERE id != 123;
SET SESSION cte_max_recursion_depth = 5000;  -- or larger

with recursive ancestors as
(
select id,name,manager_id 
from employee 
where id =123
union all 
select e.id,e.name,a.manager_id
from employee e 
join ancestors a on e.id=a.manager_id
)
select * from ancestors where id!=123;

#69

SELECT department_id, AVG(salary) AS median_salary
FROM (
    SELECT 
        department_id,
        salary,
        ROW_NUMBER() OVER (PARTITION BY department_id ORDER BY salary) AS rn_asc,
        ROW_NUMBER() OVER (PARTITION BY department_id ORDER BY salary DESC) AS rn_desc
    FROM employee
) t
WHERE rn_asc = rn_desc OR rn_asc + 1 = rn_desc OR rn_asc = rn_desc + 1
GROUP BY department_id;

#70
select
c.customer_id,
min(s.sale_date) as first_purcahse,
max(s.sale_date) as last_purchase 
from customers  c 
left join sales s on c.customer_id=s.customer_id
group by c.customer_id;

#71
WITH monthly_sales AS (
 SELECT DATE_TRUNC('month', sale_date) AS
month, SUM(amount) AS total_sales
 FROM sales
 GROUP BY month
)
SELECT month, total_sales,
 (total_sales - LAG(total_sales) OVER (ORDER
BY month)) * 100.0 / LAG(total_sales) OVER
(ORDER BY month) AS pct_change
FROM monthly_sales;

select * from sales;
with monthly_sales AS
(
SELECT date_format(sale_date,"%Y-%m-%01") as 
month,sum(amount) as total_sales
from sales
group by month 
)
select 
month,total_sales,
(total_sales -lag(total_sales) over(order by month)) *100.0/lag(total_sales) over(order by month) as pct_change
from monthly_sales;

#72
with tenture as 
(
select *,
rank() over(partition by department_id order by hire_date asc) as tenture_rank 
from employee
)
select * from tenture 
where tenture_rank=1;

#73
with monthly_sales as 
(
select 
date_format(sale_date,'%y-%m') as month,
sum(amount) as total_sales 
from sales 
group by date_format(sale_date,'%y-%m')
)
select 
ms1.month,
ms1.total_sales,
round(((ms1.total_sales -ms2.total_sales)*100.0/ms2.total_sales ),2) as growth_pct 
from monthly_sales  ms1
left join monthly_sales ms2
on date_sub(str_to_date(concat(ms1.month,'-01'),'%y-%m-%d'),interval  1 year)
=str_to_date(concat(ms2.month,'-01'),'%y-%m-%d');

#74
select 
s1.employee_id,s1.shift_id  as shift1,
s2.shift_id as shift2
from shifts s1
join shifts s2 on s1.employee_id=s2.employee_id
and s1.shift_id<>s2.shift_id 
where s1.start_time < s2.end_time  and s1.end_time >s2.start_time;

#75
select 
customer_id,
sum(amount) as total_revenue
,
rank() over(order by sum(amount) desc) as revenue_rank
from sales 
group by customer_id;

#76
select * from promotions;

select 
e.*
from employee  e 
join promotions p 
on e.id=p.employee_id
where p.employee_id is null;

#77
WITH monthly_product_sales AS (
 SELECT product_id, DATE_TRUNC('month',
sale_date) AS month, SUM(amount) AS total_sales
 FROM sales
 GROUP BY product_id, month
),
ranked_sales AS (
 SELECT *, RANK() OVER (PARTITION BY month
ORDER BY total_sales DESC) AS sales_rank
 FROM monthly_product_sales
)
SELECT product_id, month, total_sales
FROM ranked_sales
WHERE sales_rank <= 3
ORDER BY month, sales_rank;

with monthly_product_sales as 
(
select 
product_id,
date_format(sale_date,'%Y-%m-%01') as month,
sum(amount) as total_sales 
from sales 
group by product_id,month
),
ranked_sales as 
(
select *,rank() over(partition by month order by total_sales desc) as sales_rank
from monthly_product_sales 
)
select 
product_id,month,total_sales
from ranked_sales 
where sales_rank<=3
order by month,sales_rank;

#78
select *  from orders;
select 
customer_id
from orders
where order_date>=current_date-interval 30 day 
and customer_id not in 
(
select distinct customer_id
from orders
where order_date <current_date-interval 30 day 
);

#79 
select * from orders;
select * from products;
select p.product_id,p.product_name 
from products  p 
left join orders o on p.product_id =o.order_id 
where o.order_id is null;

#80
SELECT *
FROM employee e
WHERE salary > (SELECT AVG(salary) FROM
employee WHERE department_id = e.department_id)
AND salary < (SELECT AVG(salary) FROM
employee);

#81
select 
customer_id,
count(*) as total_orders,
sum(amount) as total_sales
from sales 
where sale_Date>=current_date - interval 1 year
group by customer_id;

#82
select * from 
(
select
e.* ,row_number() over(partition by department_id order by salary desc) as rnk_dept
from employee e
) sub
where rnk_dept<=5;

#83
with recursive descendants as 
(
select 
id,
name,
manager_id
from employee 
where manager_id=12
union all 
select 
e.id,
e.name,
e.manager_id
from employee e 
inner join descendants d on e.manager_id=d.id
)
select * from descendants ;

#84
with monthly_sales as
(
select 
product_id,
date_format(sale_date,'%y-%m-%01') as month,
sum(amount) as total_amount 
from sales 
group by product_id,month 
)
select 
product_id,
month,total_amount,
avg(total_amount) over(partition by product_id order by month rows between 2 preceding and current row) as mcg_avg
from monthly_sales;

select * from employee;
#85
select
e.name,
m.name,
e.hire_Date
from employee e 
join employee m 
on e.manager_id=m.id
where e.hire_date=m.hire_date;

#86
with monthly_sales as 
(
select
product_id,
date_format(sale_date,'%Y-%m-%01') as months,
sum(amount) as total_sales 
from sales
group by product_id,months
),
rank_sales as 
(
select 
product_id,
months,
total_Sales,
row_number() over(partition by product_id order by months) as rnk 
from 
monthly_sales
)
select mp1.product_id
from rank_sales mp1
join rank_sales mp2
on mp1.product_id=mp2.product_id
and mp1.rnk=1 and mp2.rnk=2
join rank_sales mp3 on mp1.product_id=mp3.product_id  and mp3.rnk=3
where mp3.total_sales <mp2.total_sales  and mp2.total_sales <mp1.total_sales;

#87
select 
department_id,salary
from (
select 
department_id,
salary,row_number() over(partition by department_id order by salary desc) as rnk
from employee 
) sub 
where rnk=8;
select * from project_assignments;
#88
select 
e.manager_id,
count(p.project_id ) as no_of_project 
from project_assignments p join employee e on p.employee_id=e.id
group by e.manager_id
having count(p.project_id) >3;

#89
select 
e.hire_Date,
m.hire_date,
datediff(m.hire_date,e.hire_date) as difference,
e.manager_id 
from employee e join employee m on m.manager_id=e.id;

#90
select 
department_id,avg(extract(year from current_date-hire_date)) as avg_experinece 
from employee 
group by department_id
order by avg_experinece desc limit 1;

#91
SELECT p1.employee_id, p1.project_id AS project1,
p2.project_id AS project2
FROM project_assignments p1
JOIN project_assignments p2 ON p1.employee_id =
p2.employee_id AND p1.project_id <> p2.project_id
WHERE p1.start_date < p2.end_date AND p1.end_date
> p2.start_date;

select p1.employee_id,p1.project_id as project1,
p2.project_id as project2
from project_assignments p1
join project_assignments p2 on p1.employee_id=p2.employee_id and 
p1.project_id<>p2.project_id
where p1.start_date < p2.end_date and p1.end_date >
p2.start_date;

#92
WITH months AS (
 SELECT generate_series(1, 12) AS month
),
customer_months AS (
 SELECT customer_id, EXTRACT(MONTH FROM
purchase_date) AS month
 FROM sales
 WHERE EXTRACT(YEAR FROM purchase_date) =
EXTRACT(YEAR FROM CURRENT_DATE)
 GROUP BY customer_id, EXTRACT(MONTH
FROM purchase_date)
)
SELECT customer_id
FROM customer_months
GROUP BY customer_id
HAVING COUNT(DISTINCT month) = 12;

with months as 
(
select generate_series(1,12) as  month 
),
customer_match as
(
select customer_id,extract(month from sale_date) as month
from sales
where extract(year from sale_date) = extract(year from current_date) 
group by customer_id,extract(month from sale_date)
)
select 
customer_id
from customer_match
group by customer_id 
having count(distinct month)=12;

#93
select 
e.id,
e.name,e.salary
from employee e 
where e.salary  > all (
select 
salary 
from employee sub
where sub.manager_id=e.id
);

#94
WITH category_sales AS (
 SELECT category_id, product_id, SUM(amount) AS
total_sales,
 RANK() OVER (PARTITION BY category_id
ORDER BY SUM(amount) DESC) AS sales_rank
 FROM sales
 GROUP BY category_id, product_id
)
SELECT category_id, product_id, total_sales
FROM category_sales
WHERE sales_rank = 1;

select * from sales;
with category_sales as
(
select customer_id,product_id,sum(amount) as total_sales,
rank() over(partition by customer_id order by sum(amount) desc) as sales_rank
from sales 
group by customer_id,product_id
)
select customer_id,product_id,total_sales
from category_sales 
where sales_rank=1;

#95
select * from customers;
select * from orders ;

select 
c.customer_id from customers c 
left join orders o on c.customer_id=o.customer_id
group by c.customer_id
having max(o.order_date)<current_date - interval  6 month or max(o.order_date) is null;

#96
select* from salary_history;
SELECT department_id, MAX(salary) - MIN(salary)
AS salary_gap
FROM employees
GROUP BY department_id;

#97
select * from departments;
with recursive manager_budget as 
(
select
id,manager_id,
budget
from employee 
union all 
select 
d.id,d.manager_id,
mb.budget
from departments d 
join manager_budget mb on d.manager_id=mb.id 
)
select 
manager_id,sum(budget) as total_budget 
from manager_budget 
group by manager_id;

#98
WITH numbered_invoices AS (
 SELECT invoice_number, ROW_NUMBER() OVER
(ORDER BY invoice_number) AS rn
 FROM invoices
)
SELECT invoice_number + 1 AS missing_invoice
FROM numbered_invoices ni
WHERE (invoice_number + 1) <> (
 SELECT invoice_number FROM numbered_invoices
WHERE rn = ni.rn + 1
);

#99
with ranked_employees as 
(
select e.*,row_number() over(partition by department_id order by salary desc) as rnk 
from employee e
)
select 
*,((rnk-1)/10)+1 as rank_group 
from ranked_employees;

#100
with daily_sales as
(
select product_id,
sale_date,
sum(amount) as total_sales
from sales 
group by product_id,sale_date
)
select 
product_id;

#101
select 
customer_id
from sales 
where product_id in('a','b')
group by customer_id
having count(distinct product_id)=2;

#102
select 
generate_series (
date_format(year,current_date),date_format(year,current_date) +interval 1 year - interval 1 day 
) as calendar_date;

#103
select 
id,
count(department_id) as dept_count
from employee
group by id
having count(department_id)>3;

#104
with monthly_sales as 
(
select 
product_id,
date_format(sale_date,'%Y-%m') as month ,
sum(amount) as product_sales 
from sales 
group by product_id,month
),
total_montly as 
(
select month,
sum(product_sales) as total_sales 
from monthly_Sales 
group by month
)
select 
ms.product_id,
ms.month,ms.product_sales,
(ms.product_sales *100.0)/tms.total_sales as
pct_contribution 
from monthly_sales ms
join total_montly tms 
on ms.month=tms.month;

#105
select
product_id,
sum(case when extract(month from sale_date)=1 then amount else 0 end)as jan,
sum(case when extract(month from sale_date)=2 then amount else 0 end)as feb,
sum(case when extract(month from sale_date)=3 then amount else 0 end)as mar,
sum(case when extract(month from sale_date)=4 then amount else 0 end)as apr,
sum(case when extract(month from sale_date)=5 then amount else 0 end)as may,
sum(case when extract(month from sale_date)=6 then amount else 0 end)as jun,
sum(case when extract(month from sale_date)=7 then amount else 0 end)as jly,
sum(case when extract(month from sale_date)=8 then amount else 0 end)as aug,
sum(case when extract(month from sale_date)=9 then amount else 0 end)as sept,
sum(case when extract(month from sale_date)=10 then amount else 0 end)as oct,
sum(case when extract(month from sale_date)=11 then amount else 0 end)as nov,
sum(case when extract(month from sale_date)=12 then amount else 0 end)as decm
from sales
group by product_id
order by product_id;

#106
select * from 
(
select 
o.*,row_number() over(partition by o.customer_id order by order_date desc) as rn
from orders o 
) sub
where rn<=3;

#107
SELECT e.*
FROM employees e
LEFT JOIN leaves l ON e.id = l.employee_id
WHERE l.leave_id IS NULL;

#108
with jan_orders as 
(
select distinct customer_id
from orders 
where extract(month from order_date)=1
),
feb_orders as
(
select distinct customer_id
from orders 
where extract(month from order_date)=2
)
select 
customer_id
from jan_orders 
where customer_id not in (select customer_id from feb_orders);

#109
with average_saleries as
(
select 
department_id,
avg(salary) as avg_salary
from employee 
group by department_id
),
ranked_series as
(
select 
department_id,
avg_salary,
dense_rank() over(order by avg_salary desc )as rnk
from average_saleries
)
select 
department_id,avg_salary 
from ranked_series 
where rnk=2;

#110
select
e1.id as emp1_id ,e2.id as emp2_id,
e1.hire_date 
from employee e1
join employee e2
on e1.id<>e2.id and extract(month from e1.hire_date)=extract(month from e2.hire_date)
and extract(year from e1.hire_date)=extract(year from e1.hire_date);

#111
with recursive hirearchy as
(
select 
id,name,manager_id,
  1 as level 
  from employee 
  where manager_id is null 
  union all 
  select e.id,e.name,e.manager_id,h.level+1
  from employee e 
  join hirearchy h on e.manager_id=h.manager_id
  )
  select * from hirearchy order by level,manager_id;
  
#112
 select 
 department_id,
 max(salary) as second_highest_salary
 from employee e1
 where salary <
 (
 select max(salary)
 from employee e2
 where e2.department_id=e1.department_id
 )
 group by department_id;
 
#113
with monthly_sales as
(
select product_id,
date_format(sale_date,"%Y-%m") as month,
sum(amount) as total_sales 
from sales 
group by product_id,month 
)
select 
product_id,month,total_sales,(total_sales - lag(total_sales) over (partition by product_id order by month))*100.0
/lag(total_sales) over(partition by product_id order by month) as pct_change
from monthly_sales;

#114
select *,
count(*) over(partition by col1,col2,col3) as cnt
from table_named
where cnt>1;

#115
select 
product_id,'q1' as quarter,q1_sales as sales from sales_date 
union all 
select 
product_id,'q2' as quarter,q2_sales as sales from sales_date 
union all 
select 
product_id,'q3' as quarter,q3_sales as sales from sales_date 
union all 
select 
product_id,'q4' as quarter,q4_sales as sales from sales_date;

#116
select * from 
employee e
where salary >(select avg(salary) from employee where department_id=e.department_id)and salary<(select avg(salary) from employee);

#117
with yearly_sales as
(
select customer_id,extract(year from sale_date) as year,
sum(amount) as total_amount 
from sales 
group by customer_id,year()
),
ranked_sales as 
(
select *,rank()over(partition by year order by total_amount desc) as rnk
from yearly_sales 
)
select customer_id,year,total_amount
from ranked_sales 
where rnk=1;

#118
select 
e.*
from employee e 
join 
(
select 
department_id,avg(salary) as avg_Salary 
from employee
group by department_id)
d on e.department_id=d.department_id and e.salary=d.avg_salary;

#119
select 
customer_id,
min(order_date) as first_order_date
from orders 
group by customer_id;

#120
select 
employee_id,
count(*) as promotion_count
from promotions 
group by employee_id
having count(*) >2;

#121
select 
e.*
from employee e 
left join project_assignments pa on e.id=pa.employee_id
where pa.project_id is null;

#122
select 
c.customer_id,
coalesce(sum(s.amount),0) as total_sales 
from customers c
left join sales s on c.customer_id=s.customer_id
group by c.customer_id;

#123
with dept_mx as
(
select department_id,max(salary)  as max_salary
from employee 
group by department_id
)
select 
e.*
from employee e 
left join dept_mx  d on e.department_id=d.department_id and e.salary=d.max_salary;

#124
select c.customer_id
from customers c 
left join orders o on c.customer_id=o.customer_id and o.order_date >= current_date - interval 1 year 
where o.order_id is null;

#125
with dept_max as (
select department_id,max(salary)  as max_salary 
from employee
group by department_id
)
select 
e.*
from employee e 
join dept_max d on e.department_id=d.department_id 
where e.salary>=0.9*d.max_salary;


#126
select 
sale_date,
sum(amount) over(order by sale_date rows between unbounded preceding and current row) as running_total 
from sales
order by sale_date;

#127
select * from employee e 
where salary >(
select 
avg(salary) from employee
);

#128 
select 
* from 
( select o.*,row_number() over(partition by customer_id order by order_date) as rnk 
 from orders  o 
 ) sub 
 where rnk <=3;
 
 #129
 select 
 customer_id,
 max(order_date)-min(order_date) as days_between
 from orders 
 group by customer_id;
 
 #130
 select * from project_assignments;
 
 select employee_id
 from project_assignments
 group by employee_id
 having count(distinct project_id)=(select count(*) from project_assignments);
 
 
 #131
 select 
 customer_id
 from orders 
 group by customer_id
 having min(order_date)>=current_date - interval 6 month;
 
 #132
 with recursive dates as
 (
 select 
 min(order_date)  as day 
 from orders 
 union all 
 select date_add(day,interval 1 day)
 from dates
 where day<(select max(order_date) from orders)
 )
 select
 d.day,
 count(o.order_id) as order_count
 from dates d
 left join orders o  on
 d.day=o.order_date
 group by d.day 
 order by d.day;
 
 #133
 select 
 department_id,
 count(*) as cnt
 from employee 
 group by department_id
 order by cnt desc;
 
 #134
with numbered as 
(
select id,
row_number() over(order by id) as rnk
from employee 
)
select rnk+1
as ran
from numbered
where id<>rnk;

#135
select 
e.name as employee_name,
m.name as manger_name,
e.hire_date,
m.hire_date
from employee e 
join employee m 
on e.manager_id=m.id
where e.hire_date>m.hire_date;

#136
select 
department_id,
avg(salary) as avg_salary 
from employee 
group by department_id
having avg(salary) >(select avg(salary) from employee);

#137
select 
dependent_id,
count(*) as dependentcount
from dependents 
group by dependent_id
order by dependentcount desc;

#138
with orderd_date as
(
select 
customer_id,
order_date,
lag(order_date) over(partition by customer_id order by order_date) as prev_cont_date 
from orders 
),
gaps as
(
select 
customer_id,
order_date-prev_cont_date as gaps 
from orderd_date
where prev_cont_date is not null
)
select 
customer_id,
max(gaps)  as max_gaps 
from gaps 
group by customer_id
order by max_gaps desc limit 1;

#139
select 
customer_id
from sales 
where product_id in (select product_id from products where category_id=1)
group by customer_id
having count(distinct product_id)=(select count(*) from products where category_id=1);

#140
select 
customer_id,
max(order_date) as max_days
from orders
group by customer_id;

#141
select 
e.name as employee_id,
m.name as manager_id
from employee e 
join employee m 
on e.manager_id=m.id;

#142
select 
e.name as employee_name,
m.name as manager_name
from employee e 
join employee m 
on e.manager_id=m.id 
where e.salary=m.salary;

#143
with avg_sales as
(
select 
avg(amount) as avg_amount
from sales
)
select 
product_id,
sum(amount) as total_Sales 
from sales
group by product_id
having sum(amount) >(select avg_amount from avg_sales);

#144
select 
extract(year from hire_date) as hire_year,
count(*) as emp_count
from employee 
group by hire_year 
order by hire_year;

#145
select 
department_id,job_title,
count(*) as count_mem
from employee 
group by department_id,job_title;

#146
select 
* from employee 
where manager_id is null;

#147
select 
department_id,job_title,
avg(salary)
from employee 
group by department_id,job_title;

#148
select 
avg(salary) as avg_salary 
from 
(
select 
salary,
row_number() over(order by salary ) as row_num,
count(*) over() as total_rows
from employee
) as ranked 
where row_num in(floor((total_rows+1)/2),ceil((total_rows+1)/2));

#149 
select * from promotions;

select 
employee_id,
count(*) as promotion_cout
from promotions
group by employee_id
having (count(*) >1);

#150
select 
p.category_id,sum(s.amount) as total_sales
from sales s
join products p 
on s.product_id=p.product_id
group by p.category_id;

#151
select 
product_id,
sum(amount) as total_sales 
from sales
group by product_id
order by total_sales desc limit 3;

#152
select * from departments;
select
e.* from employee e 
join departments d 
on e.department_id=d.department_id
where e.hire_date>d.creation_date;
 
#153
select 
c.* from customers c
join sales s
on c.customer_id=s.customer_id
where sale_id is null;

#154
select 
max(salary) from employee 
where salary <(select max(salary) from employee);

#155
select 
product_id
from sales
group by product_id 
having max(sale_Date) >=date_format(current_date,"%Y-%m") and min(sale_date) >=date_format(current_date,"%Y-%m") ;

#156
with attendece as 
(
select 
employee_di,work_date,
work_date-interval 1 day *
row_number() over(partition by employee_id order by work_date) as grp 
from work_log
)
select 
emplotee_id,
count(*) 
from attendence 
group by employee_ied,grp 
having count(*) >1 ;

#157
select 
avg(order_count)  avg_count
from 
(select 
customer_id,
count(*) as order_count 
from orders 
group by customer_id
) sub;

#158
select 
employee_id,
count(distinct project_id)as count_project 
from project_assignments
group by employee_id
having count(distinct project_id) >5;

#159
select 
sale_Date,
sum(quantity) as total_quantity 
from sales 
group by sale_Date
order by sale_date;

#160
select customer_id,
sum(amount) as total_Sales 
from sales 
group by customer_id
having sum(amount)>10000;

#161
select 
e.* from employee e 
join bonusus b 
on e.id=b.employee_id 
where b.bonus_id is null;

#162
select 
department_id,
avg(salary) as avg_salary 
from employee
group by department_id
order by avg_salary 
 limit 1;

#163
select 
customer_id,
order_date,
count(*) over(partition by customer_id order by order_date) as cummulative_orders 
from orders;

#164
select 
customer_id
from sales s
join products p on s.product_id=p.product_id
group by customer_id
having count(distinct p.product_id)=1;

#165
select 
e.name as employee_name,
m.name as manager_name
from employee e 
join employee m 
on e.manager_id=m.id;

#166
with monthly_sales  as(
select
product_id,
date_format(sale_Date,'%Y-%m') as month,
sum(amount) as total_Sales 
from sales
where sale_date >=date_sub(curdate(), interval 3 month)
group by product_id,month 
),
ranked_sales as
(
select 
product_id,
month,total_sales,
row_number() over(partition by product_id order by month) as rn
from monthly_sales 
)
select 
rs1.product_id from ranked_sales rs1 join ranked_sales rs2
on rs1.product_id=rs2.product_id and rs2.rn=2
join ranked_sales rs3 on 
rs1.product_id=rs2.product_id and rs3.rn=3
where rs1.rn=1
and rs1.total_sales >rs2.total_sales 
and rs2.total_sales >rs3.total_sales 
group by rs1.product_id;

#167
with recursive subordinates as
(
select 
id,name,manager_id
from employee 
where id =manager_id
union all 
select 
e.id,
e.manager_id
from employee e 
join subordinates s on e.manager_id=s.id
)
select * from subordinates where id!=manager_id;

#168
select 
department_id,
var_samp(salary) as diff
from employee 
group by department_id
order by diff desc limit 1;

#169
select * from orders;
select * from sales;
select 
customer_id,
sale_date,amount,
amount-lag(amount) over(partition by customer_id order by sale_date) as diff
from sales;

#170
select 
customer_id 
from sales 
where product_id in("a","b")
group by customer_id
having count(distinct product_id)=2;

#171
select 
customer_id,
sum(amount) as total_sales 
from sales
group by customer_id
order by total_sales desc limit 2;

#172
select 
date_format(sale_date,'%y-%m') as month ,
sum(amount) as total_sales 
from sales 
where extract(year from sale_date)=extract(year from current_date)
group by month 
order by total_sales desc;

#173
select  * from project_assignments;
select
employee_id
from project_assignments
where end_date>date_add(start_date,interval 6 month);

#174
select 
id,salary 
from employee 
where salary<all(select salary from employee order by salary desc limit 4) 
order by salary desc limit 1;

SELECT id, salary
FROM employee
WHERE salary = (
  SELECT DISTINCT salary
  FROM employee
  ORDER BY salary DESC
   limit  1 OFFSET 1
);

select distinct salary 
from employee 
order by salary desc
limit 1 offset 4;

#175
select 
extract(year  from hire_Date)as year ,avg(salary) as avg_Salary
from employee 
group by year 
order by year desc;

#176
with ordered as 
(
select 
e.*,
percent_rank() over(order by salary ) as pr 
from employee  e
)
select 
* from ordered
where pr between 0.25 and 0.75;

#177
select 
e.* from employee e
join 
(
select department_id,avg(salary) as avg_salary 
from employee 
group by department_id
) d on e.department_id=d.department_id
where e.salary>d.avg_salary;

#178
select
sale_Date,
amount-lag(amount) over(order by sale_Date) as diff
from sales;

#179'
select
* from emplpoyee
where current_date>date_add(hire_date,interval 6 month);

#180 
select * from promotions;

select 
e.department_id,count(*) as promotion_count
from promotions p 
join employee e 
on p.employee_id=e.id
group by e.department_id
order by promotion_count desc limit 1;

#181
select 
customer_id
from sales s
join products p on 
s.product_id=p.product_id
group by customer_id
having count(distinct p.category_id)>=3;

#182
with ordered_orders as
(
select 
customer_id,order_date-lag(order_date) over(partition by customer_id order by order_date) as prev_order_date
from orders 
),
gaps as 
(
select
customer_id,
order_date,
prev_order_date as gap 
from ordered_orders 
where prev_order_date is not null
)
select customer_id,avg(gap) as avg_gap_days 
from gaps 
group by customer_id;

#183
select 
customer_id
from customers
where customer_id not in
(
select distinct customer_id 
from sales 
where product_id='x'
);

#184
select * from customers;
select * from orders;
select 
c.country,count(o.order_id) as order_count,sum(o.order_value) as total_revenue
from customers c 
join orders o on c.customer_id=o.customer_id
group by c.country;

#185
select 
e.name as employee,m.name as manager_id,
e.hire_date
from employee e 
join employee m 
on e.manager_id=m.id
where e.hire_date=m.hire_date;

#186
SELECT category_id, product_id, total_quantity
FROM (
 SELECT p.category_id, s.product_id,
SUM(s.quantity) AS total_quantity,
 ROW_NUMBER() OVER (PARTITION BY
p.category_id ORDER BY SUM(s.quantity) DESC) AS
rn
 FROM sales s
 JOIN products p ON s.product_id = p.product_id
 GROUP BY p.category_id, s.product_id
) sub
WHERE rn <= 3;

#187
select 
customer_id,
max(order_date)-min(order_date) as days_between 
from orders
group by customer_id;

#188
with monthly_orders as
(
select customer_id,date_format(order_date,"%y-%m") as month,
count(*) as orders_count
from orders
where order_date>=current_date-interval 3 month 
group by customer_id,month 
)
select 
customer_id,orders_count
from monthly_orders
group by customer_id,orders_count
having count(*)=3
and min(orders_count)<max(orders_count);

#189
select 
e.*from employee e
join
(
select job_title,avg(salary) as avg_salary
from employee 
group by job_title 
) j 
on e.job_title=j.job_title
where e.salary=j.avg_salary;

#190
select 
e.name,m.name as manager_name,e.salary,m.salary as manager_Salary,
e.salary-m.salary  as salary_diff
from employee e
join employee m on e.manager_id=m.id;

#191
select
d.*
from departments d 
join employee e 
on d.department_id=e.department_id
where e.id is null;

#192
with dept_max as
(
select 
department_id,max(salary) as max_salary 
from employee 
group by department_id
)
select 
e.* from employee e
join dept_max d on e.department_id=d.department_id
and e.salary=d.max_salary;

#193
with days as
(
SELECT generate_series(CURRENT_DATE -
INTERVAL 6 day, CURRENT_DATE, INTERVAL
1 day  
)
SELECT customer_id
FROM orders o
JOIN days d ON o.order_date = d.day
GROUP BY customer_id
HAVING COUNT(DISTINCT o.order_date) = 7;

#194
select 
product_id,max(quantity) as max_quantity
from sales 
group by product_id
order by max_quantity desc limit 1;

#195
select
e.* 
from employee e
join departments d 
on e.department_id=d.department_id
where e.hire_date<d.creation_date;

#196
select
customer_id
from sales 
group by customer_id
having count(distinct extract(year from sale_date)) >=3;

#197
WITH company_avg AS (SELECT AVG(salary) AS
avg_salary FROM employees),
 dept_avg AS (
 SELECT department_id, AVG(salary) AS
avg_salary
 FROM employees
 GROUP BY department_id
 )
SELECT e.*
FROM employees e, company_avg ca
JOIN dept_avg da ON e.department_id =
da.department_id
WHERE e.salary > ca.avg_salary AND e.salary <
da.avg_salary;

#198
select * from orders;
select
customer_id,
extract(year from order_date ) as year,
avg(order_date) as avg_order_date 
from orders
group by customer_id,year;

#199
select 
distinct pa.employee_id
from project_assignments pa
join projects p on pa.project_id=p.project_id
where p.budget > 100000;

#200
select employees_id,
max(promotion_date) as last_promotion_date
from promotions
group by employee_id;

#201
with average_order as 
(
select avg(order_value) as avg_amount from orders
)
select 
customer_id,sum(order_value) as total_amount 
from orders 
group by customer_id
having sum(order_value)>(select avg_amount from average_order);

#202
select 
product_id 
from products
where product_id  not in (select distinct product_id from products);

#203
select 
date_format(sale_date,'%Y-%m') as month,
sum(amount) as total_amount 
from sales 
where sale_Date>=current_date - interval 1 year 
group by month 
order by total_amount 
limit 1;

#204
select 
date_format(hire_date,"%y-%m") as month,
count(*) as no_of_hires 
from employee 
where hire_date >= current_date- interval 1 year 
group by month 
order by no_of_hires 
limit 1;

#205
select 
department_id ,
count(*) as project_count 
from projects 
group by department_id
order by project_count desc;

#206
select 
e.* from employee 
join dependents d on e.id=d.employee_id 
where d.dependent_id  is null;

#207
select 
c.category_id,coalesce(sum(s.amount),0)
 as total_sales 
 from categories c 
 join products p on c.category_id=p.category_id
 join sales s on p.product_id=s.product_id
 group by c.category_id;
 
 #208
 select * from promotions;
 select 
 e.id,
 e.name 
 from employee e 
 join promotions p 
 on e.id=p.employee_id
 where e.salary<= any (select old_salary from promotions 
 where employee_id=e.id 
 order by promotion_date desc 
 );
 
 #209
 select * from orders;
 select 
 customer_id,
 sum(order_value) as total_amount 
 from orders
 group by customer_id
 having sum(order_value) > 500;
 
 #210
 select
 order_id,sum(quantity) as total_quanty 
 from order_list 
 group by order_id 
 having sum(quantity) >500;
 
 #211
 with monthly_sales as
 (
 select 
 product_id,
 date_format(sale_date,'%y-%m') as month,
 sum(amount) as total_sales 
 from sales 
 group by product_id,month
 ),
 sale_comparision as 
 (
 select 
 product_id,month ,total_Sales,
 lag(total_sales) over(partition by product_id order by month ) as rnnk
 from monthly_sales 
 )
 select 
 product_id,
 total_sales,
 month 
 from sale_comparision
 where rnnk is not null and 
 total_sales>=2*rnnk;
 
 #212
 select * from project_assignments;
 
 select 
 employee_id,
 count(distinct project_id ) as total_projects 
 from project_assignments
 where start_date between '2023-01-01' and '2023-12-31' and end_date between '2023-01-01' and '2023-12-31'
 group by employee_id
 having  count(distinct project_id ) >3;
 
 select 
 employee_id,
 count(distinct project_id) as total_projects 
 from project_assignments
 where extract(year from start_date)=2023 and extract(year from end_date)=2023
 group by employee_id
order by total_projects desc ;
 
 
 #213
select * from orders;
select 
customer_id,
max(order_date) as max_orders 
from orders 
group by customer_id
having max(order_date)<current_date-interval 1 year;

#214
select * from promotions;

select 
e.department_id,
avg((e.salary-p.old_salary)/p.old_salary*100) as avg_salary 
from employee e 
join promotions p 
on e.id=p.employee_id
group by e.department_id;

#215
select * from employee 
where id not in(
select employee_id from promotions);

#216
select * from orders;
select 
order_id
from orders 
where count(distinct customer_id)=(select count(*) from customers);

#217
select 
customer_id,
sum(order_value) as total_value 
from orders
where order_date >=current_date-interval 6 month 
group by customer_id 
having sum(order_value) >500;

#218
select 
*,row_number() over(partition by department_id order by salary desc) as rnk_emp 
from employee;

#219
with order_count as 
(
select 
customer_id,
product_id,
count(*) as total_count
from sales 
group by customer_id,product_id
)
select 
customer_id,
product_id
from order_count 
where total_count=1;

#220
select hire_date,
count(*) as count_hire 
from employee 
group by hire_date 
order by count_hire desc limit 1;

#221
select * from departments;
select 
id
from employee e 
join departments d on e.department_id=d.department_id
group by id
having count(distinct d.department_id) > 1;

#222
select * from sales;
select customer_id,sum(quantity) as total_quantity 
from sales 
where extract(year from sale_date)=2023
group by customer_id
order by total_quantity desc limit 1;

#223
select * from orders;
select 
shipping_method,avg(shipping_date-order_date) as avg_shipping_days 
from orders 
group by shipping_method ;

#224
select 
pa1.employee_id,pa2.employee_id 
from project_assignments pa1
join project_assignments pa2
on  pa1.employee_id=pa2.employee_id
and pa1.project_id<>pa2.project_id
where pa1.start_date<=pa2.end_date and pa2.start_date<=pa1.end_date;

#225
select 
p.category_id,
count(distinct customer_id ) as unique_customers 
from sales s 
join products p on s.product_id=p.product_id
group by p.category_id;

#226
with monthely_orders as
(
select
customer_id,date_format(order_date,'%y-%m') as month ,
count(*) as order_count 
from orders 
group by customer_id,month 
),

orders_comparison as
(
select 
customer_id,month,order_count,
lag(order_count) over(partition by customer_id order by month) prev_month_details 
from monthely_orders
)
select 
customer_id,month 
from orders_comparison
where prev_month_details is not null and 
order_count >=1.2*prev_month_details ;

#227
select 
e.* 
from employee e 
join project_assignments p 
on e.id=p.employee_id and p.start_date >=current_date-interval 6 month 
where p.project_id is null;

#228
select 
employee_id 
from employee_department_history 
group by employee_id
having count(distinct department_id)>2;

#229
select * from products;
select 
product_id,avg(rating)as avg_ratinsg
from product_reviews 
group by product_id 
order by avg_ratinsg desc limit 1;

#230
select 
customer_id 
from orders 
where discount_used="false";

#231
select 
e.id,
e.name,
e.department_id
from employee e 
join project_assignments p 
on e.id=p.employee_id and e.project_id=p.project_id
group by 
e.id,
e.name,
e.department_id
having (e.project_id)=(p.project_id);

#232
with ordered_orders as
(
select order_value,
ntile(100) over(order by order_value desc) as percentile 
from orders 
)
select 
avg(order_value)
from ordered_orders 
where percentile >5;

#233
select * from salary_history;

with last_year_salary as
(
select 
id,
salary as last_year_salary 
from employee
where year=extract(Year from current_date)-1
),
with_salary_current_year as
(
select 
id,
salary as present_year_salary 
from employee
where year=extract(Year from current_date)
)
select 
l.id,
p.present_year_salary -l.last_year_salary  as salary 
from with_salary_current_year p join last_year_salary l 
on p.id=l.id
order by salary desc;

#234
select 
distinct manager_id 
from employee
where id not in (select distinct manager_id  from employee);

#235
select
extract(month from hire_date) as month,
extract(year from hire_date)as year,
avg(salary) as avg_Salary 
from employee 
group by month,year 
order by month,year desc;

#236
select order_id,customer_id,order_date 
from
(
select 
o.order_id,o.customer_id,o.order_date,
row_number() over(partition by o.customer_id order by o.order_date desc) as rn
from orders o 
join customers c 
on o.customer_id=c.customer_id
where o.order_date >=c.created_date
) sub 
where rn <=5;

#237
select
sale_Date,product_id,amount,
avg(amount) over(partition by product_id order by sale_date rows between 2 preceding and current row) as moving_acg_3_days
from sales;

#238
select * from employee ;
select 
birth_day,count(*) as no_of_days 
from employee 
group by birth_day
having count(*) >1;

#239
select
customer_id,
order_date,
count(*) as order_count
from orders
group by customer_id,
order_date
having count(*) >1;

#240
select 
p.product_id,
coalesce(sum(amount),0) as total_Sales
from products p 
left join sales s on p.product_id=s.product_id
group by p.product_id;

#241
SELECT department_id, employee_id, project_count
FROM (
 SELECT e.department_id, pa.employee_id,
COUNT(DISTINCT pa.project_id) AS project_count,
 ROW_NUMBER() OVER (PARTITION BY
e.department_id ORDER BY COUNT(DISTINCT
pa.project_id) DESC) AS rn
 FROM project_assignments pa
 JOIN employees e ON pa.employee_id = e.id
 GROUP BY e.department_id, pa.employee_id
) sub
WHERE rn <= 5;


#242
select 
weather_data,max(temparature)-min(temparature) as diff_tempt
from weather_Data 
group by weather_Data 
order by diff_tempt
desc;

#243
select 
order_id,customer_id,order_date
from
(
select 
order_id,customer_id,order_date,
row_number()  over(partition by customer_id order by order_date desc) as rn
from orders
) sub 
where rn<=3;

#244
select 
product_id
from sales s
join customers c
on s.customer_id=c.customer_id
group by product_id
having count(distinct c.country)=1;

#245
select 
* from employee 
where salary >all(
select salary from employee where department_id=10);

#246
with total_emploees as 
(
select 
count(*) as total from employee 
)
select 
department_id,count(*)*100.0/(
select total from total_emploees)
from employee
group by department_id;

#247
SELECT department_id,
       AVG(salary) AS median_salary
FROM (
    SELECT department_id,
           salary,
           ROW_NUMBER() OVER (PARTITION BY department_id ORDER BY salary) AS rn,
           COUNT(*) OVER (PARTITION BY department_id) AS cnt
    FROM employees
) AS ranked
WHERE rn IN (FLOOR((cnt + 1) / 2), CEIL((cnt + 1) / 2))
GROUP BY department_id;

#248
select * from project_assignments;

select 
employeeid,
project_id,
max(end_date-start_date) as diff
from project_assignments
group by employeeid,
project_id
order by diff desc;

#249
select 
customer_id,min(order_date) as first_order
from orders 
group by customer_id;

#250
select 
category_id,product_id,price
from 
(
select 
category_id,product_id,price,
row_number() over(partition by category_id order by price desc) as rnk
from products
) sub
where rnk=2;

#251
with max_Salary as
(
select 
job_title,max(salary) as max_Salary 
from employee 
group by job_title
)
select 
e.* from employee e 
join max_Salary m 
on e.job_title=m.job_title and e.salary=m.max_salary;

#252
select * from employee;
select 
department_id,
sum(case when gender='m' then 1 else 0 end) *1.0/nullif(sum(case when gender='f'then 1 else o end ),0) as male_to_female_ratio 
from employee 
group by department_id;

#253
select * from customers;
select * from orders;
with avg_salary_by_country as
(
select 
c.country,avg(o.order_value) as avg_spent
from customers c 
join orders o 
on c.customer_id=o.customer_id
group by c.country 
)
select 
sum(o.order_value) as spent_in_person,
c.customer_id,c.country,a.avg_spent
from customers c
join orders o 
on c.customer_id=o.customer_id
join avg_salary_by_country a on a.country=c.country
group by c.customer_id,c.country,a.avg_spent
having sum(o.order_value)>a.avg_spent;

#254
select * from project_assignments;
select 
e.* from employee e
join project_assignments pa on 
e.id=pa.employee_id and pa.start_date>=current_date-interval 1 year 
where pa.project_id is null;

#255
select * from customers;
select customer_id,country,total_Spent
from (
select 
c.customer_id,
c.country,
sum(order_value) as total_spent,
row_number() over(partition by c.customer_id order by sum(order_value) desc) as rnk 
from customers c
join orders o on 
c.customer_id=o.customer_id
group by c.customer_id,c.country
) sub
where rnk<=3;
#256 
select 
e.name as employee_name,
m.name as manager_name,
e.hire_date,
m.hire_date
from employee e 
join employee m 
on e.manager_id=e.id
where e.hire_date>m.hire_date;

#257
with catergory_products as
(
select 
product_id 
from products
where category_id=10
),
customer_products as 
(
select 
customer_id,product_id 
from sales 
where product_id in (select product_id from catergory_products)
)
select 
customer_id
from customer_products
group by customer_id
having count(distinct product_id)=(select count(*) from customer_products);

#258
select 
manager_id ,count(*) as reports 
from employee 
group by manager_id
order by reports desc ;

#259 
with montly_date as(
select 
customer_id,date_format(order_date,"%y-%m") as month 
from orders
group by customer_id,month
);

#259
select 
department_id,
avg(extract(year from age(current_date,birt_date))) as avg_date
from employee
group by department_id
order by avg_date limit 1;

#260
with quaterly_sales as
(
select 
product_id,
quarter(sale_Date) as quater
from sales 
where extract(year from sale_Date)=extract(year from current_date)
group by product_id,quater
)
select
product_id
from 
quaterly_sales
group by product_id 
having count(distinct product_id)>=4;

#261
with monthly_sales as
(
select customer_id,date_format(order_date,"%y-%m") as month ,
count(*) as order_count
from orders
group by customer_id,month
),
orders_with_lags as 
(
select
customer_id,
month,order_count,
lag(order_count,1) over(partition by customer_id order by month ) as prev_1,
lag(order_count,2) over(partition by customer_id order by month) as prev_2
from monthly_sales
)
select 
distinct customer_id
from orders_with_lags
where order_count<prev_1<prev_2;

#262
select 
employee_id,
count(*) as total_emp 
from attendance
where arrival_time>scheduled_arrival_time 
group by employee_id 
order by total_emp desc limit 1;

#263
select * from orders;
with order_pairs as
(
select 
o1.order_id,o2.order_id,o1.product_id as product1,o2.product_id as product2
from orders o1
join orders o2 on o1.order_id=o2.order_id 
and o1.product_id < o2.product_id
)
select 
product1,product2,count(*) as toatl_count 
from order_pairs
group by product1,product2
order by toatl_count limit 1;

#264
with weekly_hours as
(
select 
employee_id,
week(work_date) as week_start,sum(hours_weekend) as total_hours 
from work_logs 
group by employee_id,week_start
)
select 
employee_id,week_start,total_hours 
from weekly_hours
where total_hours >40;

#265
select * from sales ;
select 
salesperson_id,sum(amount) as total_Sales
from sales 
group by salesperson_id;

#266
select 
customer_id
from customers
where customer_id not in (select 
distinct customer_id from orders where 
order_date>=current_date - interval 1 year
);

#267
with monthly_Sales as
(
select 
product_id,
date_format(sale_Date,"%y-%m") as month,
sum(amount) as total_value 
from sales 
where sale_date>=current_date- interval 3 month 
group by product_id,month
),
sales_ranked as
(
select 
product_id,month,total_value,
lag(total_value,1) over(partition by product_id order by total_value ) as rnk1,
lag(total_value,2) over(partition by product_id order by total_value ) as rnk2
from monthly_Sales
)
select 
product_id 
from sales_ranked 
where total_value >rnk1 and rnk1>rnk2;

#268
with company_salary as
(
select avg(salary) as avg_salary 
from employee
)
select 
department_id,avg(Salary) as avg_dept_salary 
from employee 
group by department_id
having avg(salary)>(select avg_salary from company_salary );

#269
select distinct order_id
from orders
group by order_id
having min(quantity)<=5;

select * from orders;

#270
select
s.product_id
from sales s
join customers c on s.customer_id=c.customer_id
group by product_id
having count(distinct c.country)=1;

#271
select
e.di,
e.name
from employee e
left join time_sheets t on e.id=t.employee_id and t.time_sheet_date>=current_date - interval 1 month 
where t.timesheet_id is null;

#272
select * from orders;
select 
date_format(order_date,'%y-%m') as month,sum(order_value) as discont_value 
from orders 
group by month 
order by month;

#273
select * from orders;
select 
distinct customer_id
from orders 
where payment_method="credit card";

#274
with dept_avg_salary as
(
select
department_id,
avg(salary) as avg_salary 
from employee 
group by department_id
)
select 
e.* from employee e
join dept_avg_salary d 
on e.department_id=d.department_id
where e.salary between d.avg_salary*0.9 and d.avg_salary*1.1;

#275
with product_totals as
(
select 
c.customer_id,p.product_id,p.category_id,
sum(s.quantity) as total_quantity,
rank() over(partition by c.customer_id order by  sum(s.quantity) desc) as rnk 
from sales s
join products p on s.product_id=p.product_id
join customers c on c.customer_id=s.customer_id
group by c.customer_id,p.product_id,p.category_id
)
select
customer_id,category_id,total_quantity 
from product_totals
where rnk=1;

#276
select * from project_assignments;
select 
project_id,
start_date,end_date,
end_date-start_date as duration 
from project_assignments
order by duration desc limit 5;

#277
select 
e.id,e.name
from employee e 
left join leaves l on e.id=l.employee_id and
l.leave_Date>=current - interval 6 month 
where l.leave_id is null;

#278
select * from project_assignments;
select 
department_id,count(*) as completed_projects 
from projects 
where status="completed" and completion_date between date_format(current_date,"%y-%m")-interval 1 year and date_format(current_date,"%y-%m")
- interval 1 year 
group by department_id
order by completed_projects  desc limit 1;

#279
with monthly_sales as
(
select 
customer_id,
date_format(order_date,'%m') as month,
count(*) as order_count
from orders 
group by customer_id,month
),
order_with_lag as
(
select 
customer_id,month,order_count,
lag(order_count,1) over(partition by customer_id order by month ) as prev1,
lag(order_count,2) over(partition by customer_id order by month ) as prev2
from monthly_sales
)
select 
customer_id
from order_with_lag
where order_count>prev1 and prev1>prev2;

#280
select 
distinct e.id,e.name 
from employee e 
join project_assignments p on e.id=p.employee_id
where e.department_id !=p.department_id;

#281
select 
support_agent_id,avg(closed_date-opened_Date) as avg_closing_time 
from suppoert_tickets 
where closed_date is not null
group by support_agent_id;

#282
select 
user_id,
max(login_date) as last_day,
min(login_date) as frst_day
from user_logins 
group by user_id;

#283
with customer_months as
(
select
customer_id,date_format(order_date,"%M") as month 
from orders
group by customer_id,month 
)
select
customer_id
from customer_months
group by customer_id
having count(*)  >1;

#284
with avg_Sales as
(
select avg(total_revunue ) as avg_amount 
from 
(
select 
product_id,sum(amount) as total_revunue 
from sales 
group by product_id
) sub
)
select 
product_id ,sum(amount) as total_sales 
from sales
group by product_id 
having sum(amount)>(select avg_amount from avg_Sales);

#285
select 
department_id
from employee 
group by department_id
having avg(case when salary >60000 then 1 else 0 end)>0.5;

#286

with project_id as
(
select 
count(distinct project_id) as project_count 
from project_assignments
),
employee_count as
(
select 
employee_id,
count(distinct project_id) as project_worked
from project_assignments
group by employee_id
)
select 
e.employee_id
from employee_count e join 
project_id pa on 1=1
where e.project_worked=pa.project_count ;


#287
with category_count as
(
select 
count(distinct product_id ) as products_count
from products
),
sale_count as
(
select 
s.customer_id,
count(distinct s.product_id ) as sale_count
from sales s
join products p on s.product_id=p.product_id
group by s.customer_id
)
select 
customer_id
from sale_count  a join 
category_coun c on 1=1
where c.products_count=a.sale_count;

#288
select 
department_id,
avg(timestampdiff(Year,hire_date,curdate())) as avg_tenture_years 
from employee
group by department_id;

#289
select
case
when dayofweek(order_date) in (1,7) then'weekend' else 'weekday'
end  as day_type
,
count(*) as total_orders
from orders
group by day_type;

#290
select 
date_format(order_date,"%m") as month,
100*sum(case when order_value>0 then 1 else 0 end )/count(*) as total_discount 
from orders
group by month ;

select *from orders;

#291
select 
e.id,e.name
from employee e 
join attendance a on e.id=a.employee_id 
and a.arrival_time>a.scheduled_time
where a.employee_id is null;

#292
select 
product_id
from sales s
join holidays h on s.sale_date=h.holiday_date
group by product_id
having count(*) =(select count(*)from sales where product_id=s.product_id);

#293
with current_year as
(
select 
department_id,count(*) as emp_count
from employee
where hire_date<=(current_date and termination_date is null or termination_date>=current_Date)
group by department_id
),
last_year as
(
select 
department_id,count(*) as emp_count
from employee
where hire_date<=(current_date -interval 1 year and ( termination_date is null or termination_date>=current_Date- interval 1 year))
group by department_id
)
SELECT c.department_id, c.emp_count -
COALESCE(l.emp_count,0) AS increase
FROM current_year c
LEFT JOIN last_year l ON c.department_id =
l.department_id
ORDER BY increase DESC
LIMIT 1;

#294
select * from sales;
select * from orders;
select 
o.shipping_method,
avg(o.order_value) as avg_amount
from orders o join 
customers c on o.customer_id=c.customer_id
group by o.shipping_method;

#295
select
manager_id,count(distinct( project_id)) as project_count
from employee 
group by manager_id
having count(distinct project_id)>3;


#296
select 
p.product_id
from products p 
join returns r 
on p.product_id=r.product_id 
where r.return_id is null;

#297
select * from orders;
select 
o.orde_id 
from orders o 
join ehipments s on o.order_id = s.order_id 
where shipment_id is null;

#298
with saalry_diff as
(
select 
employee_id,
date_format(hire_date,"%Y")as year,salary,
lag(salary) over(partition by employee_id order by year) as prev_Salary 
from employee 
)
select 
distinct employee_id
from saalry_diff
where salary> prev_Salary  is null 
group by employee_id 
having count(*)=(select 
count(*) from employee e1 where e1.employee_id=saalry_diff.employee_id
);

#299
select 
count(distinct product_id) as od_product
from sales 
where sale_date>=makedate(year(curdate()),1) + interval quarter(curdate())*3-6 month 
and sale_date< (
makedate(year(curdate()),1) + interval quarter(curdate())*3-6 month
);

SELECT COUNT(DISTINCT product_id) AS
unique_products_sold
FROM sales
WHERE sale_date >= date_format(
CURRENT_DATE,quarter) - INTERVAL 3 month
 AND sale_date < date_format(CURRENT_DATE,quarter);
 
 
 
 #300
 with daily_sales as
 (
 select 
 date(order_date) as day ,
 sum(order_value) as total_sales 
 from orders 
 group by day 
 ),
 ranked_function as
 (
 select 
 day,total_sales,
 rank() over(partition by date_format(day,'%m') order by total_sales) as sales_rank 
 from daily_sales
 )
 select 
 day,total_sales 
 from ranked_function 
 where sales_rank =1;
 
 #301
 with monthly_sales as
 (
 select 
 product_id,date_format(sale_date,"%m") as month 
,
sum(amount) as total_sales 
from sales 
group by product_id,month 
),
comparision as
(
select 
product_id,month,total_sales ,
lag(total_sales) over(partition by product_id order by month) as  prev_Sales 
from monthly_sales 
)
select 
product_id,month,total_sales- prev_Sales as increase
from comparision
where prev_Sales is not null 
order by increase desc limit 1;

#302
select 
customer_id,
sum(order_value) as total_sales 
from  orders
where order_date >=current_date - interval 1 year 
group by customer_id
order by total_sales desc limit 5;

#303
select
count(distinct employee_id) 
from employee_department_history
where chnage_date<=current_date-interval 1 year;

#304
select 
department_id,
avg(salary) as total_salary,
job_title 
from employee
group by department_id,job_title;

#305
select * from orders;

select 
customer_id 
from orders
group by customer_id
having count(distinct shipping_method)>1;

#306
select * from products;
select 
category_id,product_id,avg(ratings) as avg_ratings 
from products 
group by category_id,product_id,row_number() over(partition by category_id order by avg(ratings))>1;

#307
select * from promotions;
select
e.id,
e.name 
from employee e 
join promotions p on e.id=p.employee_id
where p.promotion_id is null;

#308
select 
date(order_date) as day ,
count(*) as order_count
from orders
where order_date>=current_date-interval 7 day
group by order_date
order by order_date ;

#309
select * from orders;

select 
customer_id 
from orders
group by customer_id
having count(distinct shipping_method)>1;

#310
select 
sale_rep_id,count(*) as deals_close 
from sale_seals 
where deal_close_date >=date_format(current_date,quarter);

#311
select 
p.product_id
from products p 
join sales s
on p.product_id=s.product_id
where p.discountuned-true;

#312
select 
e.id as employee_id,e.name,m.id as manager_id
from employee e
join employee m
on e.manager_id=m.id 
where e.hire_date>m.hire_date;

#313
select 
d.department_id 
from departments d 
join job_openings o 
on d.department_id=j.department_id and j.status="open"
where j.job_ is null;

#314 
with salary_rank as
(
select 
salary,percent_rank() over(order by salary desc) as pr from employee 
)
select 
e.* from employee e
join salary_rank  s
on e.salary=s.salary
where s.salary<=0.05;

#315
select 
o.product_id 
from orders o 
join products p 
on o.product_id=p.product_id
where cast(o.order_date as date)=p.launch_date;

#316
select 
employee_id,date_format(work_Date,'%w') as week,
sum(hours_worked) as hours_worked 
from work_logs 
group by employee_id,week 




